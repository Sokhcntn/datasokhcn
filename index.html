<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản trị Nhiệm vụ Chiến lược</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
        }

        .dashboard-height { height: 28vh; }
        .sidebar-width { width: 16vw; }
        .submenu-height { height: 8vh; } 
        .content-height { height: 64vh; }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .status-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card-main {
            @apply flex flex-col items-center justify-center px-6 border-r border-slate-700 last:border-0;
        }

        .stat-card-sub {
            @apply flex flex-col items-center justify-center px-6 border-r border-blue-200 last:border-0;
        }

        .active-main-menu {
            @apply bg-blue-600 text-white shadow-lg shadow-blue-900/20;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 flex">

    <!-- SIDEBAR -->
    <aside class="sidebar-width h-screen bg-slate-900 text-white flex flex-col shadow-2xl z-50">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-black tracking-tighter text-blue-400 text-center uppercase">Quản lý nhiệm vụ</h1>
        </div>
        
        <nav class="flex-1 mt-6">
            <div class="px-6 mb-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest italic text-center">Nhóm nhiệm vụ chính</div>
            <ul id="mainMenu" class="space-y-1 px-3"></ul>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-950/50">
            <label class="flex items-center gap-2 cursor-pointer bg-blue-600 hover:bg-blue-700 p-3 rounded-xl transition text-[11px] font-bold justify-center uppercase shadow-lg">
                <i data-lucide="file-up" class="w-4 h-4"></i>
                Nạp dữ liệu Excel
                <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls">
            </label>
        </div>
    </aside>

    <!-- RIGHT SECTION -->
    <div class="flex-1 flex flex-col overflow-hidden">
        
        <!-- DASHBOARD -->
        <header class="dashboard-height flex flex-col shadow-sm z-30">
            <div class="h-1/2 bg-slate-800 text-white flex items-center px-10 gap-8">
                <div class="flex-1">
                    <p class="text-blue-400 font-bold text-[10px] uppercase tracking-widest mb-1">Thống kê file hiện tại</p>
                    <h2 id="dashboardTitle" class="text-2xl font-black leading-none uppercase tracking-tighter italic text-blue-100"></h2>
                </div>
                <div class="flex items-center h-full py-4">
                    <div class="stat-card-main">
                        <div id="stat-total" class="text-3xl font-black">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Tổng dòng nạp</div>
                    </div>
                    <div class="stat-card-main">
                        <div id="stat-pending" class="text-3xl font-black text-amber-400">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Đang thực hiện</div>
                    </div>
                    <div class="stat-card-main border-0">
                        <div id="stat-done" class="text-3xl font-black text-emerald-400">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Đã hoàn thành</div>
                    </div>
                </div>
            </div>

            <div class="h-1/2 bg-blue-600 text-white flex items-center px-10 gap-8 shadow-inner">
                <div class="flex-1 flex flex-col">
                    <div class="flex items-center gap-2">
                        <i data-lucide="layers" class="w-4 h-4 opacity-70"></i>
                        <p id="currentSubLabel" class="text-xl font-bold italic tracking-tight">Vui lòng chọn mục</p>
                    </div>
                    <p class="text-[10px] font-medium text-blue-200 uppercase opacity-80 mt-1">Nội dung chi tiết & Tổng hợp (Sum)</p>
                </div>
                <div class="flex items-center h-full py-4">
                    <div class="stat-card-sub">
                        <div id="stat-sub-total" class="text-3xl font-black">0</div>
                        <div class="text-[9px] font-bold text-blue-100 uppercase tracking-tighter">Sum (Nhiệm vụ)</div>
                    </div>
                    <div class="stat-card-sub border-0">
                        <div id="stat-sub-done" class="text-2xl font-black text-blue-200">0</div>
                        <div class="text-[9px] font-bold text-blue-100 uppercase tracking-tighter">Đã xong</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- SUBMENU SELECTOR -->
        <div class="submenu-height bg-white border-b border-slate-200 flex items-center px-10 overflow-x-auto custom-scroll gap-2" id="subMenu"></div>

        <!-- MAIN TABLE CONTENT -->
        <main class="content-height p-4 overflow-hidden bg-slate-100/50">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 h-full flex flex-col overflow-hidden">
                <div class="overflow-auto custom-scroll flex-1">
                    <table class="w-full border-collapse text-left relative">
                        <thead class="sticky top-0 bg-slate-50 z-20 shadow-sm border-b border-slate-200">
                            <tr>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-14 text-center">STT</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase">Nội dung nhiệm vụ</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-40 text-center">Đơn vị / Phân loại</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-32 text-center">Hạn giao</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-60 text-center">Tiến độ</th>
                            </tr>
                        </thead>
                        <tbody id="taskBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="noDataView" class="hidden flex flex-col items-center justify-center p-20 text-slate-400">
                        <i data-lucide="info" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p class="font-bold">Không tìm thấy dữ liệu phù hợp với bộ lọc trong file nạp.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const menuConfig = {
            "Sở": { 
                label: "Sở KH&CN", 
                icon: "flask-conical", 
                subs: ["Văn phòng", "P.CĐS", "P.KH", "P.TĐC", "P.CN&ĐMST", "P.TC-KH", "TT. CĐS", "TT.KH&CN", "ĐMST"] 
            },
            "UBND tỉnh": { 
                label: "UBND Tỉnh", 
                icon: "landmark", 
                subs: ["Kịch bản tăng trưởng", "KH2390", "KH658", "Đề án 1330", "CTHĐ KT-XH", "CTLV"] 
            },
            "NQ57": { label: "Nghị quyết 57", icon: "file-text", subs: ["Hành động", "Hạ tầng", "Nhân lực", "Ngân sách"] },
            "Tỉnh ủy": { label: "Tỉnh ủy", icon: "building-2", subs: ["Nghị quyết 11", "CTHD33", "CTLV25"] },
            "Big Problems": { 
                label: "Big Problems", 
                icon: "zap", 
                subs: ["UAV", "Kinh tế số", "Carbon", "Halal", "Năng lượng", "Hệ sinh thái", "AI"] 
            }
        };

        const progressOptions = ["Chưa làm", "Đang xử lý", "Chờ duyệt", "Đã hoàn thành"];

        let masterData = []; 
        let currentMainKey = "";
        let currentSubName = "TẤT CẢ";

        function init() {
            renderMainMenu();
            selectMain("Sở");
            lucide.createIcons();
        }

        function renderMainMenu() {
            const menuHtml = Object.keys(menuConfig).map(key => {
                const cfg = menuConfig[key];
                return `
                    <li>
                        <button onclick="selectMain('${key}')" id="menu-${key}" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-xs group">
                            <i data-lucide="${cfg.icon}" class="w-4 h-4 opacity-40 group-hover:opacity-100"></i>
                            <span class="flex-1 text-left uppercase tracking-tight">${cfg.label}</span>
                        </button>
                    </li>
                `;
            }).join('');
            document.getElementById('mainMenu').innerHTML = menuHtml;
        }

        function selectMain(key) {
            currentMainKey = key;
            document.querySelectorAll('#mainMenu button').forEach(btn => btn.classList.remove('active-main-menu'));
            const activeBtn = document.getElementById(`menu-${key}`);
            if (activeBtn) activeBtn.classList.add('active-main-menu');
            
            const cfg = menuConfig[key];
            document.getElementById('dashboardTitle').innerText = cfg.label;
            
            // Xây dựng SubMenu
            const allSubs = ["TẤT CẢ", ...cfg.subs];
            const subHtml = allSubs.map(sub => `
                <button onclick="selectSub('${sub}')" class="sub-btn whitespace-nowrap px-4 py-2 rounded-lg border border-slate-200 text-[11px] font-black uppercase transition-all bg-slate-50 hover:bg-white hover:shadow-sm">
                    ${sub}
                </button>
            `).join('');
            document.getElementById('subMenu').innerHTML = subHtml;
            
            if (masterData.length === 0) {
                generateSampleData();
            }
            
            selectSub("TẤT CẢ");
        }

        function generateSampleData() {
            masterData = [
                { id: "sample1", "Nội dung": "Vui lòng nạp file Excel để bắt đầu thống kê", "Đơn vị": "Hệ thống", "Hạn": "---", "Tiến độ": "Chưa làm" }
            ];
        }

        function selectSub(sub) {
            currentSubName = sub;
            document.getElementById('currentSubLabel').innerText = sub === "TẤT CẢ" ? `Tổng hợp: ${menuConfig[currentMainKey].label}` : sub;
            
            document.querySelectorAll('.sub-btn').forEach(btn => {
                if(btn.innerText.trim() === sub.trim()) {
                    btn.classList.add('bg-blue-700', 'text-white', 'border-blue-700');
                    btn.classList.remove('bg-slate-50');
                } else {
                    btn.classList.remove('bg-blue-700', 'text-white', 'border-blue-700');
                    btn.classList.add('bg-slate-50');
                }
            });
            renderDisplay();
        }

        function renderDisplay() {
            const body = document.getElementById('taskBody');
            const emptyView = document.getElementById('noDataView');
            const currentSubs = menuConfig[currentMainKey].subs;

            let filteredTasks = [];

            // CHUẨN HÓA LOGIC LỌC
            if (currentSubName === "TẤT CẢ") {
                // SUM: Lấy tất cả các dòng mà Content hoặc Unit chứa bất kỳ SubMenu nào của nhóm này
                filteredTasks = masterData.filter(t => {
                    const content = (t["Nội dung"] || "").toString().toLowerCase();
                    const unit = (t["Đơn vị"] || "").toString().toLowerCase();
                    return currentSubs.some(s => {
                        const searchKey = s.toLowerCase().trim();
                        return content.includes(searchKey) || unit.includes(searchKey);
                    });
                });
            } else {
                // CHI TIẾT: Lọc chính xác theo từ khóa SubMenu đang chọn
                const searchKey = currentSubName.toLowerCase().trim();
                filteredTasks = masterData.filter(t => {
                    const content = (t["Nội dung"] || "").toString().toLowerCase();
                    const unit = (t["Đơn vị"] || "").toString().toLowerCase();
                    return content.includes(searchKey) || unit.includes(searchKey);
                });
            }

            // HIỂN THỊ LÊN BẢNG
            if (filteredTasks.length === 0) {
                body.innerHTML = "";
                emptyView.classList.remove('hidden');
            } else {
                emptyView.classList.add('hidden');
                body.innerHTML = filteredTasks.map((task, index) => {
                    const isDone = task["Tiến độ"] === 'Đã hoàn thành';
                    return `
                        <tr class="hover:bg-slate-50 transition border-b border-slate-100 last:border-0">
                            <td class="p-4 text-center font-bold text-slate-300 text-xs">${index + 1}</td>
                            <td class="p-4 font-semibold text-slate-800 text-sm leading-relaxed">${task["Nội dung"]}</td>
                            <td class="p-4 text-center">
                                <span class="text-[9px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded uppercase tracking-tighter">
                                    ${task["Đơn vị"] || "Chưa phân loại"}
                                </span>
                            </td>
                            <td class="p-4 text-center text-xs font-mono font-bold text-slate-600">${task["Hạn"] || "---"}</td>
                            <td class="p-4">
                                <div class="flex items-center gap-2">
                                    <select onchange="updateRow('${task.id}', this.value)" class="flex-1 bg-white border border-slate-200 rounded p-1.5 text-[10px] font-bold shadow-sm focus:border-blue-500 outline-none">
                                        ${progressOptions.map(opt => `<option value="${opt}" ${task["Tiến độ"] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                    <span class="status-badge ${isDone ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'} min-w-[75px] text-center">
                                        ${isDone ? 'Xong' : 'Đang xử lý'}
                                    </span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            // CẬP NHẬT CÁC CON SỐ SUM VÀ STATS
            updateStats(filteredTasks);
            lucide.createIcons();
        }

        function updateRow(id, val) {
            const task = masterData.find(t => t.id.toString() === id.toString());
            if(task) {
                task["Tiến độ"] = val;
                renderDisplay();
            }
        }

        function updateStats(filtered) {
            // Stats tổng của toàn bộ file
            document.getElementById('stat-total').innerText = masterData.length;
            document.getElementById('stat-done').innerText = masterData.filter(t => t["Tiến độ"] === "Đã hoàn thành").length;
            document.getElementById('stat-pending').innerText = masterData.filter(t => t["Tiến độ"] !== "Đã hoàn thành").length;
            
            // Stats SUM của mục đang chọn (nếu là TẤT CẢ thì là tổng nhóm)
            document.getElementById('stat-sub-total').innerText = filtered.length;
            document.getElementById('stat-sub-done').innerText = filtered.filter(t => t["Tiến độ"] === "Đã hoàn thành").length;
        }

        // XỬ LÝ FILE EXCEL
        document.getElementById('excelInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // Refresh masterData
                masterData = raw.map((row, idx) => {
                    const keys = Object.keys(row);
                    const findValue = (terms) => {
                        const key = keys.find(k => terms.some(t => k.toLowerCase().replace(/\s/g, '').includes(t)));
                        return key ? row[key] : "";
                    };

                    return {
                        id: `task-${Date.now()}-${idx}`,
                        "Nội dung": findValue(["nộidung", "nhiệmvụ", "côngviệc", "tên"]),
                        "Đơn vị": findValue(["đơnvị", "cơquan", "chủtrì", "phòng", "mục"]),
                        "Hạn": findValue(["hạn", "thờigian", "ngày"]),
                        "Tiến độ": findValue(["tiếndộ", "trạngthái"]) || progressOptions[0]
                    };
                }).filter(t => t["Nội dung"] && t["Nội dung"].toString().trim() !== "");

                // Sau khi nạp thành công, ưu tiên hiển thị SUM của nhóm "Sở"
                currentMainKey = "Sở";
                selectMain("Sở");
            };
            reader.readAsArrayBuffer(file);
        });

        window.onload = init;
    </script>
</body>
</html>
