<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ thống Quản trị Nhiệm vụ Chiến lược</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
        }

        .dashboard-height { height: 28vh; }
        .sidebar-width { width: 16vw; }
        .submenu-height { height: 8vh; } 
        .content-height { height: 64vh; }

        .custom-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .status-badge {
            font-size: 10px;
            font-weight: 800;
            padding: 2px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card-main {
            @apply flex flex-col items-center justify-center px-6 border-r border-slate-700 last:border-0;
        }

        .stat-card-sub {
            @apply flex flex-col items-center justify-center px-6 border-r border-blue-200 last:border-0;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 flex">

    <!-- SIDEBAR -->
    <aside class="sidebar-width h-screen bg-slate-900 text-white flex flex-col shadow-2xl z-50">
        <div class="p-6 border-b border-slate-800">
            <h1 class="text-xl font-black tracking-tighter text-blue-400 text-center uppercase">Quản lý nhiệm vụ</h1>
        </div>
        
        <nav class="flex-1 mt-6">
            <div class="px-6 mb-3 text-[10px] font-bold text-slate-500 uppercase tracking-widest italic text-center">Nhóm nhiệm vụ chính</div>
            <ul id="mainMenu" class="space-y-1 px-3"></ul>
        </nav>

        <div class="p-4 border-t border-slate-800 bg-slate-950/50">
            <label class="flex items-center gap-2 cursor-pointer bg-blue-600 hover:bg-blue-700 p-3 rounded-xl transition text-[11px] font-bold justify-center uppercase shadow-lg shadow-blue-900/20">
                <i data-lucide="file-up" class="w-4 h-4"></i>
                Nạp dữ liệu Excel
                <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls">
            </label>
        </div>
    </aside>

    <!-- RIGHT SECTION -->
    <div class="flex-1 flex flex-col overflow-hidden">
        
        <!-- DASHBOARD (2 DÒNG) -->
        <header class="dashboard-height flex flex-col shadow-sm z-30">
            <div class="h-1/2 bg-slate-800 text-white flex items-center px-10 gap-8">
                <div class="flex-1">
                    <p class="text-blue-400 font-bold text-[10px] uppercase tracking-widest mb-1">Tổng quan toàn bộ hệ thống</p>
                    <h2 id="dashboardTitle" class="text-2xl font-black leading-none uppercase tracking-tighter italic text-blue-100"></h2>
                </div>
                <div class="flex items-center h-full py-4">
                    <div class="stat-card-main">
                        <div id="stat-total" class="text-3xl font-black">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Tổng nhiệm vụ</div>
                    </div>
                    <div class="stat-card-main">
                        <div id="stat-pending" class="text-3xl font-black text-amber-400">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Đang thực hiện</div>
                    </div>
                    <div class="stat-card-main">
                        <div id="stat-overdue" class="text-3xl font-black text-rose-500">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Quá hạn nhóm</div>
                    </div>
                    <div class="stat-card-main border-0">
                        <div id="stat-done" class="text-3xl font-black text-emerald-400">0</div>
                        <div class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">Đã hoàn thành</div>
                    </div>
                </div>
            </div>

            <div class="h-1/2 bg-blue-600 text-white flex items-center px-10 gap-8 shadow-inner">
                <div class="flex-1 flex flex-col">
                    <div class="flex items-center gap-2">
                        <i data-lucide="layers" class="w-4 h-4 opacity-70"></i>
                        <p id="currentSubLabel" class="text-xl font-bold italic tracking-tight">Đang xem tất cả</p>
                    </div>
                    <p class="text-[10px] font-medium text-blue-200 uppercase opacity-80 mt-1">Trạng thái mục đang chọn</p>
                </div>
                <div class="flex items-center h-full py-4">
                    <div class="stat-card-sub">
                        <div id="stat-sub-total" class="text-3xl font-black">0</div>
                        <div class="text-[9px] font-bold text-blue-100 uppercase tracking-tighter">Số lượng mục này</div>
                    </div>
                    <div class="stat-card-sub">
                        <div id="stat-sub-pending" class="text-2xl font-black">0</div>
                        <div class="text-[9px] font-bold text-blue-100 uppercase tracking-tighter">Đang xử lý</div>
                    </div>
                    <div class="stat-card-sub border-0">
                        <div id="stat-sub-done" class="text-2xl font-black text-blue-200">0</div>
                        <div class="text-[9px] font-bold text-blue-100 uppercase tracking-tighter">Hoàn thành</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- SUBMENU SELECTOR (Thêm nút "TẤT CẢ") -->
        <div class="submenu-height bg-white border-b border-slate-200 flex items-center px-10 overflow-x-auto custom-scroll gap-2" id="subMenu"></div>

        <!-- MAIN TABLE CONTENT -->
        <main class="content-height p-4 overflow-hidden bg-slate-100/50">
            <div class="bg-white rounded-xl shadow-lg border border-slate-200 h-full flex flex-col overflow-hidden">
                <div class="overflow-auto custom-scroll flex-1">
                    <table class="w-full border-collapse text-left relative">
                        <thead class="sticky top-0 bg-slate-50 z-20 shadow-sm border-b border-slate-200">
                            <tr>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-14 text-center">STT</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase">Nội dung nhiệm vụ</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-40 text-center">Đơn vị chủ trì</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-32 text-center">Hạn giao</th>
                                <th class="p-4 text-[10px] font-bold text-slate-400 uppercase w-64 text-center">Tiến độ cập nhật</th>
                            </tr>
                        </thead>
                        <tbody id="taskBody" class="divide-y divide-slate-100"></tbody>
                    </table>
                    <div id="noDataView" class="hidden flex flex-col items-center justify-center p-20 text-slate-300">
                        <i data-lucide="search-x" class="w-12 h-12 mb-3 opacity-20"></i>
                        <p class="font-bold">Không có dữ liệu hiển thị.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const menuConfig = {
            "Sở": { 
                label: "Sở KH&CN", 
                icon: "flask-conical", 
                subs: ["Văn phòng", "P.CĐS", "P.KH", "P.TĐC", "P.CN&ĐMST", "P.TC-KH", "TT. CĐS", "TT.KH&CN", "ĐMST"] 
            },
            "UBND tỉnh": { 
                label: "UBND Tỉnh", 
                icon: "landmark", 
                subs: ["Kịch bản tăng trưởng", "KH2390-NQ24HĐND", "KH658-QĐ2815", "Đề án 1330", "CTHĐ KT-XH 2026", "CTLV 2026"] 
            },
            "NQ57": { label: "Nghị quyết 57", icon: "file-text", subs: ["Kế hoạch hành động", "Phát triển hạ tầng", "Đào tạo nhân lực", "Phân bổ ngân sách"] },
            "Tỉnh ủy": { label: "Tỉnh ủy", icon: "building-2", subs: ["Nghị quyết 11", "CTHD33", "CTLV25"] },
            "Big Problems": { 
                label: "Big Problems", 
                icon: "zap", 
                subs: ["Dự án UAV", "Kinh tế số", "Tín chỉ Carbon", "Halal", "Năng lượng", "Hệ sinh thái ĐMST", "Quản trị AI"] 
            }
        };

        const progressOptions = [
            "Chưa làm", "CV đang xử lý", "Lãnh đạo phòng kiểm tra", 
            "PGĐ đang kiểm tra", "Giám đốc duyệt", "Đã hoàn thành",
            "Lấy ý kiến Sở ngành", "VP. UBND tỉnh", "VP Tỉnh ủy"
        ];

        let masterData = []; 
        let currentMainKey = "";
        let currentSubName = "TẤT CẢ"; // Mặc định xem hết

        function init() {
            renderMainMenu();
            selectMain("Sở");
            lucide.createIcons();
        }

        function renderMainMenu() {
            const menuHtml = Object.keys(menuConfig).map(key => {
                const cfg = menuConfig[key];
                return `
                    <li>
                        <button onclick="selectMain('${key}')" id="menu-${key}" class="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all font-semibold text-xs group">
                            <i data-lucide="${cfg.icon}" class="w-4 h-4 opacity-40 group-hover:opacity-100"></i>
                            <span class="flex-1 text-left uppercase tracking-tight">${cfg.label}</span>
                        </button>
                    </li>
                `;
            }).join('');
            document.getElementById('mainMenu').innerHTML = menuHtml;
        }

        function selectMain(key) {
            currentMainKey = key;
            document.querySelectorAll('#mainMenu button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
            const activeBtn = document.getElementById(`menu-${key}`);
            if (activeBtn) activeBtn.classList.add('bg-blue-600', 'text-white');
            
            const cfg = menuConfig[key];
            document.getElementById('dashboardTitle').innerText = cfg.label;
            
            // Xây dựng SubMenu, luôn có nút "TẤT CẢ" đầu tiên
            const allSubs = ["TẤT CẢ", ...cfg.subs];
            const subHtml = allSubs.map(sub => `
                <button onclick="selectSub('${sub}')" class="sub-btn whitespace-nowrap px-4 py-2 rounded-lg border border-slate-200 text-[11px] font-black uppercase transition-all bg-slate-50 hover:bg-white hover:shadow-sm">
                    ${sub}
                </button>
            `).join('');
            document.getElementById('subMenu').innerHTML = subHtml;
            
            // Nếu chưa có file Excel, tạo dữ liệu mẫu
            if (masterData.length === 0) {
                generateMockData(cfg);
            }
            
            selectSub("TẤT CẢ");
        }

        function generateMockData(cfg) {
            const mock = [];
            cfg.subs.forEach(sub => {
                const num = 3;
                for(let i=1; i<=num; i++) {
                    mock.push({
                        "id": Math.random().toString(36).substr(2, 9),
                        "Nội dung": `[Mẫu] Nhiệm vụ ${i} của ${sub}`,
                        "Đơn vị": sub,
                        "Hạn": "30/03/2026",
                        "Tiến độ": progressOptions[0]
                    });
                }
            });
            masterData = mock;
        }

        function selectSub(sub) {
            currentSubName = sub;
            document.getElementById('currentSubLabel').innerText = sub === "TẤT CẢ" ? "Toàn bộ danh sách" : sub;
            
            document.querySelectorAll('.sub-btn').forEach(btn => {
                if(btn.innerText.trim() === sub.trim()) {
                    btn.classList.add('bg-blue-700', 'text-white', 'border-blue-700');
                    btn.classList.remove('bg-slate-50');
                } else {
                    btn.classList.remove('bg-blue-700', 'text-white', 'border-blue-700');
                    btn.classList.add('bg-slate-50');
                }
            });
            renderDisplay();
        }

        function getStatus(prog, deadline) {
            if (prog === "Đã hoàn thành" || prog === "Giám đốc duyệt") return "DONE";
            // Logic so sánh ngày đơn giản
            return "PENDING";
        }

        function renderDisplay() {
            const body = document.getElementById('taskBody');
            const emptyView = document.getElementById('noDataView');
            
            // Lọc dữ liệu: Nếu là "TẤT CẢ" thì lấy hết masterData
            const filteredTasks = currentSubName === "TẤT CẢ" 
                ? masterData 
                : masterData.filter(t => {
                    const d = (t["Đơn vị"] || t["Cơ quan"] || t["Chủ trì"] || "").toString().toLowerCase();
                    return d.includes(currentSubName.toLowerCase());
                });

            if (filteredTasks.length === 0) {
                body.innerHTML = "";
                emptyView.classList.remove('hidden');
            } else {
                emptyView.classList.add('hidden');
                body.innerHTML = filteredTasks.map((task, index) => {
                    const status = getStatus(task["Tiến độ"], task["Hạn"]);
                    return `
                        <tr class="hover:bg-slate-50 transition">
                            <td class="p-4 text-center font-bold text-slate-300 text-xs">${index + 1}</td>
                            <td class="p-4 font-semibold text-slate-800 text-sm">
                                ${task["Nội dung"] || "Không có tiêu đề"}
                            </td>
                            <td class="p-4 text-center">
                                <span class="text-[9px] font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded uppercase">
                                    ${task["Đơn vị"] || "N/A"}
                                </span>
                            </td>
                            <td class="p-4 text-center text-xs font-mono font-bold text-slate-600">
                                ${task["Hạn"] || "---"}
                            </td>
                            <td class="p-4">
                                <div class="flex items-center gap-3">
                                    <select onchange="updateRow('${task.id}', this.value)" class="flex-1 bg-white border border-slate-200 rounded p-1.5 text-[11px] font-bold shadow-sm">
                                        ${progressOptions.map(opt => `<option value="${opt}" ${task["Tiến độ"] === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                    </select>
                                    <span class="status-badge ${status === 'DONE' ? 'bg-emerald-100 text-emerald-700' : 'bg-blue-100 text-blue-700'} min-w-[80px] text-center shadow-sm">
                                        ${status === 'DONE' ? 'Xong' : 'Đang làm'}
                                    </span>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            updateStats(filteredTasks);
            lucide.createIcons();
        }

        function updateRow(id, val) {
            const task = masterData.find(t => t.id === id);
            if(task) {
                task["Tiến độ"] = val;
                renderDisplay();
            }
        }

        function updateStats(filtered) {
            // Tổng hệ thống
            document.getElementById('stat-total').innerText = masterData.length;
            document.getElementById('stat-done').innerText = masterData.filter(t => getStatus(t["Tiến độ"]) === "DONE").length;
            
            // Theo mục đang chọn
            document.getElementById('stat-sub-total').innerText = filtered.length;
            document.getElementById('stat-sub-done').innerText = filtered.filter(t => getStatus(t["Tiến độ"]) === "DONE").length;
            document.getElementById('stat-sub-pending').innerText = filtered.filter(t => getStatus(t["Tiến độ"]) !== "DONE").length;
        }

        document.getElementById('excelInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const raw = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                
                // MAPPING CỘT THÔNG MINH
                masterData = raw.map(row => {
                    const keys = Object.keys(row);
                    const findKey = (terms) => keys.find(k => terms.some(t => k.toLowerCase().includes(t)));

                    return {
                        id: Math.random().toString(36).substr(2, 9),
                        "Nội dung": row[findKey(["nội dung", "nhiệm vụ", "công việc", "tên"])] || "N/A",
                        "Đơn vị": row[findKey(["đơn vị", "cơ quan", "chủ trì", "phòng"])] || "N/A",
                        "Hạn": row[findKey(["hạn", "thời gian", "ngày"])] || "---",
                        "Tiến độ": row[findKey(["tiến độ", "trạng thái"])] || progressOptions[0]
                    };
                });
                
                // Sau khi nạp, tự động chuyển về chế độ TẤT CẢ để xem hết kết quả
                selectSub("TẤT CẢ");
            };
            reader.readAsArrayBuffer(file);
        });

        window.onload = init;
    </script>
</body>
</html>
